<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Beating Go’s Default Protobuf for Prometheus Remote Write · czerminski.me
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Tomasz Czermiński">
<meta name="description" content="Exploring why Go&#39;s default protobuf unmarshal slows down Prometheus Remote Write, and how a custom parser doubled throughput.">
<meta name="keywords" content="blog,developer,personal">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Beating Go’s Default Protobuf for Prometheus Remote Write">
  <meta name="twitter:description" content="Exploring why Go&#39;s default protobuf unmarshal slows down Prometheus Remote Write, and how a custom parser doubled throughput.">

<meta property="og:url" content="https://www.czerminski.me/posts/protobuf/">
  <meta property="og:site_name" content="czerminski.me">
  <meta property="og:title" content="Beating Go’s Default Protobuf for Prometheus Remote Write">
  <meta property="og:description" content="Exploring why Go&#39;s default protobuf unmarshal slows down Prometheus Remote Write, and how a custom parser doubled throughput.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-09-27T00:00:00+00:00">
    <meta property="article:tag" content="Performance">
    <meta property="article:tag" content="Go">




<link rel="canonical" href="https://www.czerminski.me/posts/protobuf/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.022594d625780e2edf64581b893d32cb35c11de5d88953ea4ad3c2e45451e214.css" integrity="sha256-AiWU1iV4Di7fZFgbiT0yyzXBHeXYiVPqStPC5FRR4hQ=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/img/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://www.czerminski.me/">
      czerminski.me
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://www.czerminski.me/posts/protobuf/">
              Beating Go’s Default Protobuf for Prometheus Remote Write
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2025-09-27T00:00:00Z">
                September 27, 2025
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              13-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="/authors/tomasz-czermi%C5%84ski/">Tomasz Czermiński</a></div>

          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/performance/">Performance</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/go/">Go</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h1 id="beating-gos-default-protobuf-for-prometheus-remote-write">
  Beating Go’s Default Protobuf for Prometheus Remote Write
  <a class="heading-link" href="#beating-gos-default-protobuf-for-prometheus-remote-write">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<h2 id="project-background">
  Project Background
  <a class="heading-link" href="#project-background">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The story starts with an observability platform we were building for a large European e-commerce.<br>
It handled metrics scraping, monitoring checks, and alerting — though not logs or tracing.</p>
<p>As adoption grew, so did the problems:</p>
<ul>
<li>Some teams exported metrics with <strong>UUIDs as label values</strong>.</li>
<li>Others had pods stuck in <strong>CrashLoopBack</strong>, generating a fresh set of labels on each restart.</li>
<li>We had <strong>no way to impose restrictions</strong> on clients due to internal business politics.</li>
</ul>
<p>The result was <strong>high-cardinality explosions</strong> that caused several outages.</p>
<p>At the time, we were using <strong>VictoriaMetrics standalone</strong>, which had no concept of multi-tenancy:<br>
all timeseries went into a single blob. That meant <strong>one misbehaving user could bring down everyone</strong>.</p>
<p>We considered moving to <strong>VictoriaMetrics Cluster</strong>, but key features like downsampling were behind a paywall.<br>
When we asked about enterprise pricing, the quote was so far above our budget it wasn’t even close.</p>
<p>So we turned to <strong>Cortex</strong>. As a CNCF project, it’s fully open source and supports true multi-tenancy.<br>
The plan was simple: distribute metrics among tenants by populating the <code>X-Scope-OrgID</code> HTTP header in the Prometheus Remote Write protocol.<br>
The value for this header came from the <code>service_id</code> label, which every exported metric was required to define.</p>
<p>The final architecture looked like this:</p>
<ul>
<li>Prometheus scrapers collect metrics.</li>
<li>VMAgent does light transformations.</li>
<li>Cortex Distributor stores each timeseries in the correct tenant.</li>
</ul>
<p>The missing piece was a <strong>relay</strong>: a lightweight service that intercepted Remote Write traffic between VMAgent and Cortex, grouped metrics by <code>service_id</code>, and added the proper HTTP header.</p>
<p>That’s when the real challenge began — building a relay fast enough to handle <strong>gigabytes per second</strong> of traffic.<br>
And the very first bottleneck turned out to be… Go’s default protobuf unmarshaller.</p>
<h2 id="the-code">
  The code
  <a class="heading-link" href="#the-code">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">type</span><span style="color:#6e7681"> </span>Algo<span style="color:#6e7681"> </span><span style="color:#ff7b72">string</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">const</span><span style="color:#6e7681"> </span>(<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>SNAPPY<span style="color:#6e7681"> </span>Algo<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#34;snappy&#34;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>ZSTD<span style="color:#6e7681"> </span>Algo<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span><span style="color:#a5d6ff">&#34;zstd&#34;</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">decompress</span>(algo<span style="color:#6e7681"> </span>Algo,<span style="color:#6e7681"> </span>payload<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681"> </span>(decompressed<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>,<span style="color:#6e7681"> </span>release<span style="color:#6e7681"> </span><span style="color:#ff7b72">func</span>(),<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72">error</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span>buffer<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>buffersPool.<span style="color:#d2a8ff;font-weight:bold">Get</span>().([]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">switch</span><span style="color:#6e7681"> </span>algo<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span>SNAPPY:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>decompressed,<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>snappy.<span style="color:#d2a8ff;font-weight:bold">Decode</span>(buffer,<span style="color:#6e7681"> </span>payload)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>release<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span><span style="color:#ff7b72">func</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>cap(decompressed)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span>maxCap<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">				</span><span style="color:#ff7b72">return</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span>buffersPool.<span style="color:#d2a8ff;font-weight:bold">Put</span>(decompressed[:<span style="color:#a5d6ff">0</span>])<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span>ZSTD:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>dec<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>decodersPool.<span style="color:#d2a8ff;font-weight:bold">Get</span>().(<span style="color:#ff7b72;font-weight:bold">*</span>zstd.Decoder)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>decompressed,<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>dec.<span style="color:#d2a8ff;font-weight:bold">DecodeAll</span>(payload,<span style="color:#6e7681"> </span>buffer)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>decodersPool.<span style="color:#d2a8ff;font-weight:bold">Put</span>(dec)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>release<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span><span style="color:#ff7b72">func</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>cap(decompressed)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span>maxCap<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">				</span><span style="color:#ff7b72">return</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span>buffersPool.<span style="color:#d2a8ff;font-weight:bold">Put</span>(decompressed[:<span style="color:#a5d6ff">0</span>])<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">default</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>err<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>fmt.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(<span style="color:#a5d6ff">&#34;%w: %s&#34;</span>,<span style="color:#6e7681"> </span>ErrUnsupportedEncoding,<span style="color:#6e7681"> </span>algo)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>decompressed,<span style="color:#6e7681"> </span>release,<span style="color:#6e7681"> </span>err<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">Dispatch</span>(algo<span style="color:#6e7681"> </span><span style="color:#ff7b72">string</span>,<span style="color:#6e7681"> </span>compressed<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681"> </span><span style="color:#ff7b72">error</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span>payload,<span style="color:#6e7681"> </span>releaseBuffer,<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">decompress</span>(algo,<span style="color:#6e7681"> </span>compressed)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">defer</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">releaseBuffer</span>()<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span>tss,<span style="color:#6e7681"> </span>releaseTss,<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">Unmarshal</span>(payload)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#8b949e;font-style:italic">// We would extract service_id label here</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">UnsafeString</span>(b<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681"> </span><span style="color:#ff7b72">string</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#8b949e;font-style:italic">// #nosec G103</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">*</span>(<span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#ff7b72">string</span>)(unsafe.<span style="color:#d2a8ff;font-weight:bold">Pointer</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>b))<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">v1</span>()<span style="color:#6e7681"> </span><span style="color:#ff7b72">func</span>(<span style="color:#ff7b72;font-weight:bold">*</span>fasthttp.RequestCtx)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">func</span>(ctx<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">*</span>fasthttp.RequestCtx)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>algo<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">UnsafeString</span>(ctx.Request.Header.<span style="color:#d2a8ff;font-weight:bold">Peek</span>(<span style="color:#a5d6ff">&#34;Content-Encoding&#34;</span>))<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">Dispatch</span>(algo,<span style="color:#6e7681"> </span>ctx.Request.<span style="color:#d2a8ff;font-weight:bold">Body</span>());<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span>ctx.<span style="color:#d2a8ff;font-weight:bold">Error</span>(err.<span style="color:#d2a8ff;font-weight:bold">Error</span>(),<span style="color:#6e7681"> </span>fasthttp.StatusBadGateway)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span><span style="color:#ff7b72">return</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>ctx.Request.<span style="color:#d2a8ff;font-weight:bold">CloseBodyStream</span>();<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span>ctx.<span style="color:#d2a8ff;font-weight:bold">SetStatusCode</span>(fasthttp.StatusInternalServerError)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">			</span><span style="color:#ff7b72">return</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">		</span>ctx.<span style="color:#d2a8ff;font-weight:bold">SetStatusCode</span>(fasthttp.StatusOK)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">	</span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>The critical point in the code above is that everything was designed with performance in mind.
We chose fasthttp, so we have HTTP layer, meaning parsing and socket handling, already done. But in order to really utilize it, runtime allocations must be minimized.
That means, using <em>sync.Pool</em>, reusing slices and keeping track of lifetimes, as reference to request or its derivative must not be kept after it is released.</p>
<p>This post is about protobuf, but I want to emphasize: everything else in the relay was tuned for performance. The only real bottleneck left was the default Go protobuf unmarshaller.</p>
<h2 id="benchmarking-the-defaults">
  Benchmarking the defaults
  <a class="heading-link" href="#benchmarking-the-defaults">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>I have created a following benchmark:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>b.<span style="color:#d2a8ff;font-weight:bold">ResetTimer</span>()<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>i<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span>;<span style="color:#6e7681"> </span>i<span style="color:#6e7681"> </span>&lt;<span style="color:#6e7681"> </span>b.N;<span style="color:#6e7681"> </span>i<span style="color:#ff7b72;font-weight:bold">++</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">Dispatch</span>(ZSTD,<span style="color:#6e7681"> </span>payload);<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>b.<span style="color:#d2a8ff;font-weight:bold">Fatal</span>(err)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>and got following results:</p>
<pre tabindex="0"><code>goos: darwin
goarch: arm64
pkg: relay/tests
cpu: Apple
Benchmark_Dispatch-12               8372            127002 ns/op          193759 B/op        268 allocs/op
PASS
ok      relay/tests      2.127s
</code></pre><p>Let us take a look into pprof:</p>
<pre tabindex="0"><code>Type: alloc_space
Time: 2025-09-29 11:33:09 CEST
Entering interactive mode (type &#34;help&#34; for commands, &#34;o&#34; for options)
(pprof) top10
Showing nodes accounting for 1583.66MB, 98.75% of 1603.76MB total
Dropped 68 nodes (cum &lt;= 8.02MB)
Showing top 10 nodes out of 24
      flat  flat%   sum%        cum   cum%
 1202.18MB 74.96% 74.96%  1203.18MB 75.02%  github.com/prometheus/prometheus/prompb.(*TimeSeries).Unmarshal
  169.68MB 10.58% 85.54%   169.68MB 10.58%  github.com/gogo/protobuf/proto.Marshal
   61.69MB  3.85% 89.39%  1264.86MB 78.87%  github.com/prometheus/prometheus/prompb.(*WriteRequest).Unmarshal
      52MB  3.24% 92.63%       52MB  3.24%  github.com/klauspost/compress/zstd.encoderOptions.encoder
   46.52MB  2.90% 95.53%  1539.17MB 95.97%  relay/pkg.Dispatch
   26.97MB  1.68% 97.21%    26.97MB  1.68%  github.com/klauspost/compress/zstd.(*blockDec).reset
   23.12MB  1.44% 98.65%    23.12MB  1.44%  github.com/klauspost/compress/zstd.init.func2
       1MB 0.062% 98.71%  1596.57MB 99.55%  tests.Benchmark_Dispatch
    0.51MB 0.032% 98.75%    52.10MB  3.25%  github.com/klauspost/compress/zstd.(*Decoder).DecodeAll
         0     0% 98.75%    56.10MB  3.50%  relay/pkg.decompress
</code></pre><h3 id="why-the-default-unmarshaller-hurts">
  Why the default unmarshaller hurts
  <a class="heading-link" href="#why-the-default-unmarshaller-hurts">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The profile is pretty unambiguous:<br>
over <strong>75% of all allocations</strong> come from <code>prompb.TimeSeries.Unmarshal</code>.</p>
<p>That’s not too surprising when you think about it:<br>
the default Go protobuf implementation eagerly allocates Go structs for every label, sample, and timeseries.<br>
Even if you only need a single label like <code>service_id</code>, you still pay the cost of fully materializing the entire <code>WriteRequest</code>.</p>
<p>For us, this meant:</p>
<ul>
<li>Hundreds of allocations per request.</li>
<li>Gigabytes of heap churn per second at scale.</li>
<li>GC pressure that quickly became the bottleneck.</li>
</ul>
<p>The protobuf layer was drowning everything else.</p>
<hr>
<h2 id="a-few-words-about-protobuf">
  A few words about Protobuf
  <a class="heading-link" href="#a-few-words-about-protobuf">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The crucial thing to understand about Protobuf is that it’s a <strong>generic serialization format</strong>.<br>
It’s designed to support arbitrary data structures: you define fields, tag them with IDs, specify types, and later you can extend the schema by adding new fields.<br>
But you pay for this flexibility with <strong>reflection and allocations</strong>.</p>
<p>In most cases, this is fantastic. Protobuf gives you a compact binary wire format, backward compatibility, and performance that’s usually much better than JSON RPC or REST.</p>
<p>And to be fair — there are really fast Go protobuf libraries out there.<br>
They avoid reflection, use code generation, and can be significantly faster than the defaults.<br>
But they’re still <strong>generic decoders</strong>, and without arenas they can’t avoid the heap churn when you don’t need the full structure.</p>
<p>In my case, that generic approach was working against me.<br>
For Prometheus Remote Write, I didn’t need the full flexibility of Protobuf.<br>
I only needed to extract a single label (<code>service_id</code>) out of the payload.</p>
<p>In other words: I didn’t need a general-purpose decoder.<br>
I needed a <strong>tailored parser</strong>, specific to Remote Write 1.0.</p>
<p>If I had been using C or C++, this wouldn’t even be a problem.<br>
Their protobuf libraries support <strong>memory arenas</strong>, which sidestep these allocation issues entirely.</p>
<p>But in Go, there’s no runtime support for arenas — and likely never will be.<br>
That left me with one option: build a tailored parser myself.</p>
<h2 id="what-about-arenas-in-go-proposal-51317">
  What about arenas in Go? (Proposal #51317)
  <a class="heading-link" href="#what-about-arenas-in-go-proposal-51317">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>While Go doesn’t currently support runtime memory arenas, there <em>is</em> an open proposal in the Go project: issue <strong>#51317</strong>, titled <em>“proposal: arena: new package providing memory arenas”</em>.</p>
<p>The idea is to allow allocations into a contiguous arena and then free them all at once. For systems like ours—where many allocations are short-lived per request—this could, in theory, reduce GC overhead significantly.</p>
<p>However, the proposal is <strong>on hold indefinitely</strong> due to serious API and safety concerns. And beyond the technical hurdles, arenas also run somewhat against Go’s design philosophy. One of Go’s strengths is its simplicity and predictable memory model; introducing arenas would complicate both the mental model and the runtime.</p>
<h2 id="unmarshaling-writerequest--fast-and-cheap">
  Unmarshaling <code>WriteRequest</code> – fast and cheap
  <a class="heading-link" href="#unmarshaling-writerequest--fast-and-cheap">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Before jumping into code, it helps to understand a few low-level Protobuf details:</p>
<ul>
<li>
<p><strong>Tags are integers</strong>
Every field in a message has a unique tag number. Once assigned, it cannot be reused—this guarantees backward compatibility.</p>
</li>
<li>
<p><strong>Wire type + tag = field header</strong>
Each field begins with a small header containing its tag and wire type.
The wire type tells us how to parse the value that follows (varint, fixed64, length-delimited, etc.).</p>
</li>
<li>
<p><strong>Varints save space</strong>
Integers are encoded with variable-length encoding. Small numbers take fewer bytes.
(This isn’t unique to Protobuf—Go even provides <code>binary.Uvarint</code> in its standard library.)</p>
</li>
<li>
<p><strong>Object pooling is critical</strong>
To avoid constant allocations, I added a pool for reusing <code>TimeSeries</code> structures.
This cut down both GC pressure and latency spikes.</p>
</li>
</ul>
<hr>
<h3 id="the-writerequest-unmarshaller">
  The <code>WriteRequest</code> unmarshaller
  <a class="heading-link" href="#the-writerequest-unmarshaller">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>With those building blocks in place, here’s the tailored unmarshaller for <code>WriteRequest</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">Unmarshal</span>(buf<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681"> </span>(tss<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72;font-weight:bold">*</span>TS,<span style="color:#6e7681"> </span>release<span style="color:#6e7681"> </span><span style="color:#ff7b72">func</span>(),<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72">error</span>)<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>release<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span><span style="color:#ff7b72">func</span>()<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>_,<span style="color:#6e7681"> </span>ts<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#ff7b72">range</span><span style="color:#6e7681"> </span>tss<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#d2a8ff;font-weight:bold">Put</span>(ts)<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// return to pool</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>len(buf)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>key,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>fieldNum<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">3</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0b111</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>fieldNum<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>tss,<span style="color:#6e7681"> </span>release,<span style="color:#6e7681"> </span>fmt.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(<span style="color:#a5d6ff">&#34;unexpected field/wiretype&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>tsLen,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>tsBuf<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>buf[:tsLen]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[tsLen:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>ts<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">Get</span>()<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// grab from pool</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">timeseries</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>ts.TimeSeries,<span style="color:#6e7681"> </span>tsBuf);<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span>,<span style="color:#6e7681"> </span>release,<span style="color:#6e7681"> </span>err<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>tss<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>append(tss,<span style="color:#6e7681"> </span>ts)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>tss,<span style="color:#6e7681"> </span>release,<span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>We only care about <strong>time series</strong>. Exemplars and other fields are ignored.
That’s why any unrecognized field is just skipped.</p>
<hr>
<h3 id="decoding-a-timeseries">
  Decoding a <code>TimeSeries</code>
  <a class="heading-link" href="#decoding-a-timeseries">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Each <code>TimeSeries</code> contains labels and samples.
Here’s how I handle it:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">timeseries</span>(ts<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">*</span>prompb.TimeSeries,<span style="color:#6e7681"> </span>buf<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681"> </span><span style="color:#ff7b72">error</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>ts.Labels<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>ts.Labels[:<span style="color:#a5d6ff">0</span>]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>ts.Samples<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>ts.Samples[:<span style="color:#a5d6ff">0</span>]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>len(buf)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>key,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;failed to read key&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>fieldNum<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">3</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0b111</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">switch</span><span style="color:#6e7681"> </span>fieldNum<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// labels</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>fmt.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(<span style="color:#a5d6ff">&#34;unexpected wire type for labels: %d&#34;</span>,<span style="color:#6e7681"> </span>wireType)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>lblLen,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#6e7681"> </span>int(lblLen)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span>len(buf[n:])<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;invalid label length&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>lblBuf<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>buf[n<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>n<span style="color:#ff7b72;font-weight:bold">+</span>int(lblLen)]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n<span style="color:#ff7b72;font-weight:bold">+</span>int(lblLen):]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">var</span><span style="color:#6e7681"> </span>lbl<span style="color:#6e7681"> </span>prompb.Label<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">label</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>lbl,<span style="color:#6e7681"> </span>lblBuf);<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>ts.Labels<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>append(ts.Labels,<span style="color:#6e7681"> </span>lbl)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// samples</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>fmt.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(<span style="color:#a5d6ff">&#34;unexpected wire type for samples: %d&#34;</span>,<span style="color:#6e7681"> </span>wireType)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>sLen,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#6e7681"> </span>int(sLen)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span>len(buf[n:])<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;invalid sample length&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>sBuf<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>buf[n<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>n<span style="color:#ff7b72;font-weight:bold">+</span>int(sLen)]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n<span style="color:#ff7b72;font-weight:bold">+</span>int(sLen):]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">var</span><span style="color:#6e7681"> </span>s<span style="color:#6e7681"> </span>prompb.Sample<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">sample</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>s,<span style="color:#6e7681"> </span>sBuf);<span style="color:#6e7681"> </span>err<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>err<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>ts.Samples<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>append(ts.Samples,<span style="color:#6e7681"> </span>s)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">default</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// skip unknown fields</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">switch</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// varint</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>_,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                    </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;invalid varint skip&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// fixed64</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[<span style="color:#a5d6ff">8</span>:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// length-delimited</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>l,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n<span style="color:#ff7b72;font-weight:bold">+</span>int(l):]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">5</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// fixed32</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[<span style="color:#a5d6ff">4</span>:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">default</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>fmt.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(<span style="color:#a5d6ff">&#34;unsupported wire type: %d&#34;</span>,<span style="color:#6e7681"> </span>wireType)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><p>The idea is simple:
iterate over the buffer until it’s empty, slice it along the way, and decode only the fields we care about.</p>
<hr>
<h3 id="decoding-labels-and-samples">
  Decoding labels and samples
  <a class="heading-link" href="#decoding-labels-and-samples">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Both are straightforward:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">label</span>(lbl<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">*</span>prompb.Label,<span style="color:#6e7681"> </span>buf<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681"> </span><span style="color:#ff7b72">error</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>len(buf)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>key,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;failed to read label key&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>fieldNum<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">3</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0b111</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>fmt.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(<span style="color:#a5d6ff">&#34;unexpected wire type for label field: %d&#34;</span>,<span style="color:#6e7681"> </span>wireType)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>strLen,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#6e7681"> </span>int(strLen)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span>len(buf[n:])<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;invalid string length in label&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>strBuf<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>buf[n<span style="color:#6e7681"> </span>:<span style="color:#6e7681"> </span>n<span style="color:#ff7b72;font-weight:bold">+</span>int(strLen)]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n<span style="color:#ff7b72;font-weight:bold">+</span>int(strLen):]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">switch</span><span style="color:#6e7681"> </span>fieldNum<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>lbl.Name<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>string(strBuf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>lbl.Value<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>string(strBuf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span><span style="color:#ff7b72">func</span><span style="color:#6e7681"> </span><span style="color:#d2a8ff;font-weight:bold">sample</span>(s<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">*</span>prompb.Sample,<span style="color:#6e7681"> </span>buf<span style="color:#6e7681"> </span>[]<span style="color:#ff7b72">byte</span>)<span style="color:#6e7681"> </span><span style="color:#ff7b72">error</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">for</span><span style="color:#6e7681"> </span>len(buf)<span style="color:#6e7681"> </span>&gt;<span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>key,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;failed to read sample key&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>fieldNum<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">3</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>key<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0b111</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">switch</span><span style="color:#6e7681"> </span>fieldNum<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// value = double = fixed64</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span><span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#6e7681"> </span>len(buf)<span style="color:#6e7681"> </span>&lt;<span style="color:#6e7681"> </span><span style="color:#a5d6ff">8</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;invalid double value&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>bits<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.LittleEndian.<span style="color:#d2a8ff;font-weight:bold">Uint64</span>(buf[:<span style="color:#a5d6ff">8</span>])<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>s.Value<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>math.<span style="color:#d2a8ff;font-weight:bold">Float64frombits</span>(bits)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[<span style="color:#a5d6ff">8</span>:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// timestamp = varint</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;invalid wire type for timestamp&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>ts,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">if</span><span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">&lt;=</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span><span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>errors.<span style="color:#d2a8ff;font-weight:bold">New</span>(<span style="color:#a5d6ff">&#34;invalid timestamp varint&#34;</span>)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>s.Timestamp<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>int64(ts)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span><span style="color:#ff7b72">default</span>:<span style="color:#6e7681"> </span><span style="color:#8b949e;font-style:italic">// skip unknown fields</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">switch</span><span style="color:#6e7681"> </span>wireType<span style="color:#6e7681"> </span>{<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">0</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>_,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">1</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[<span style="color:#a5d6ff">8</span>:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">2</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>l,<span style="color:#6e7681"> </span>n<span style="color:#6e7681"> </span><span style="color:#ff7b72;font-weight:bold">:=</span><span style="color:#6e7681"> </span>binary.<span style="color:#d2a8ff;font-weight:bold">Uvarint</span>(buf)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[n<span style="color:#ff7b72;font-weight:bold">+</span>int(l):]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">case</span><span style="color:#6e7681"> </span><span style="color:#a5d6ff">5</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span>buf<span style="color:#6e7681"> </span>=<span style="color:#6e7681"> </span>buf[<span style="color:#a5d6ff">4</span>:]<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span><span style="color:#ff7b72">default</span>:<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">                </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span>fmt.<span style="color:#d2a8ff;font-weight:bold">Errorf</span>(<span style="color:#a5d6ff">&#34;unsupported wire type: %d&#34;</span>,<span style="color:#6e7681"> </span>wireType)<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">            </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">        </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span>}<span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681">    </span><span style="color:#ff7b72">return</span><span style="color:#6e7681"> </span><span style="color:#79c0ff">nil</span><span style="color:#6e7681">
</span></span></span><span style="display:flex;"><span><span style="color:#6e7681"></span>}<span style="color:#6e7681">
</span></span></span></code></pre></div><hr>
<p>👉 The bottom line:
By focusing only on <code>TimeSeries</code> (labels + samples), skipping everything else, and reusing objects from a pool, the unmarshaller becomes <strong>fast, predictable, and memory-efficient</strong>.
Perfect for Remote Write ingestion at high scale.</p>
<h2 id="benchmarking-my-unmarshaller">
  Benchmarking my unmarshaller
  <a class="heading-link" href="#benchmarking-my-unmarshaller">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Once again, let’s benchmark the code — this time replacing the default Protobuf implementation with a custom unmarshaller. The benchmark itself remains unchanged, which allows for a fair, apples‑to‑apples comparison.</p>
<h3 id="benchmark-output">
  Benchmark output
  <a class="heading-link" href="#benchmark-output">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<pre tabindex="0"><code>goos: darwin
goarch: arm64
pkg: relay/tests
cpu: Apple
Benchmark_Dispatch-12              11284            104857 ns/op           28232 B/op        111 allocs/op
PASS
ok      relay/tests      2.655s
</code></pre><p>Compared to the earlier results with the default Protobuf library, this shows a <strong>noticeable drop in allocations</strong> as well as <strong>lower execution time</strong> per operation. While the numbers might seem small in isolation, in a high-throughput system such as mine (≈4 Gbps), they add up quickly. Every avoided allocation reduces garbage collector workload, which in turn lowers pause frequency and stabilizes latency — especially at the tail (p99/p999). The freed CPU cycles can then be spent where they matter more, like serialization and compression. Beyond immediate gains, this also provides valuable headroom for scaling without hitting performance cliffs as load increases.</p>
<h3 id="memory-profile-pprof">
  Memory profile (pprof)
  <a class="heading-link" href="#memory-profile-pprof">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<pre tabindex="0"><code>Type: alloc_space
Time: 2025-09-29 17:53:57 CEST
Entering interactive mode (type &#34;help&#34; for commands, &#34;o&#34; for options)
(pprof) top10
Showing nodes accounting for 557.43MB, 98.06% of 568.47MB total
Dropped 41 nodes (cum &lt;= 2.84MB)
Showing top 10 nodes out of 29
      flat  flat%   sum%        cum   cum%
  347.34MB 61.10% 61.10%   347.34MB 61.10%  github.com/gogo/protobuf/proto.Marshal
  107.05MB 18.83% 79.93%   494.32MB 86.95%  relay/pkg.Dispatch
   62.95MB 11.07% 91.00%    62.95MB 11.07%  github.com/klauspost/compress/zstd.encoderOptions.encoder
   11.50MB  2.02% 93.03%    19.21MB  3.38%  relay/pkg.Unmarshal
   11.19MB  1.97% 95.00%    11.19MB  1.97%  github.com/klauspost/compress/zstd.(*blockDec).reset
    5.70MB  1.00% 96.00%     5.70MB  1.00%  relay/pkg.init.func3
    4.47MB  0.79% 96.79%     4.47MB  0.79%  github.com/klauspost/compress/zstd.(*blockEnc).init
    4.02MB  0.71% 97.49%     4.02MB  0.71%  github.com/klauspost/compress/zstd.init.func2
    1.70MB   0.3% 97.79%     6.69MB  1.18%  github.com/klauspost/compress/zstd.(*Encoder).Reset
    1.50MB  0.26% 98.06%    18.22MB  3.20%  relay/pkg.decompress
</code></pre><h3 id="observations">
  Observations
  <a class="heading-link" href="#observations">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<ul>
<li><strong>Deserialization is no longer a hotspot.</strong> In the previous profile, deserialization was eating a large chunk of allocations. With the tailored unmarshaller, its footprint is down to just ~2%.</li>
<li><strong><code>proto.Marshal</code> still dominates.</strong> The serialization path remains the single biggest contributor to allocation pressure. This makes sense — Remote Write still requires encoding back into protobuf wire format when shipping samples, and the encoder is still generic.</li>
<li><strong>Compression is non‑trivial.</strong> Zstd compression shows up prominently in the profile. While not the focus of this experiment, it’s a reminder that in end‑to‑end pipelines, serialization and compression overheads often dominate CPU and memory.</li>
</ul>
<h3 id="key-takeaway">
  Key takeaway
  <a class="heading-link" href="#key-takeaway">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Optimizing Protobuf deserialization gave us a <strong>leaner, lower‑allocation hot path</strong>, directly improving throughput and latency stability. However, the profile also reveals the next bottleneck: serialization. In other words, <em>every performance win just shifts the spotlight to the next limiting factor</em> — and that’s exactly how profiling‑driven optimization should work.</p>
<h2 id="final-thoughts">
  Final thoughts
  <a class="heading-link" href="#final-thoughts">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Generic libraries are great — they solve a wide range of problems with one tool. But when you’re pushing systems at multi-gigabit throughput, the overhead of generality becomes very real.</p>
<p>In my case, Protobuf’s default Go implementation was doing far more work than I needed. By focusing on a <strong>narrow use case</strong> (extracting a single label from Remote Write payloads) and writing a <strong>custom unmarshaller</strong>, I was able to cut allocations, lower latency, and make the system more predictable under load.</p>
<p>The takeaway is simple:</p>
<ul>
<li>Always measure before optimizing.</li>
<li>Let profiling show you where the real bottlenecks are.</li>
<li>Don’t be afraid to go beyond “default” libraries when your workload demands it.</li>
</ul>
<p>One thing I still don’t quite understand is why Remote Write relies on such a <strong>generic binary format</strong>. Metrics are a very specific workload, and they could benefit from a format tailored to their characteristics. The overhead of serialization alone, at least in large organizations, directly translates into <strong>significant infrastructure costs.</strong>.</p>

      </div>


      <footer>
        

<section class="see-also">
  
    
    
    
  
</section>


        <div id="disqus_thread"></div>
<script>
  window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "short" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    
    document.addEventListener('themeChanged', function (e) { 
        if (document.readyState == 'complete') {
          DISQUS.reset({ reload: true, config: disqus_config });
        }
    });
</script>
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2019 -
    
    2025
     Tomasz Czermiński 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
